<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <changeSet id="1" author="mikitatsikhan">
        <ext:createCollection collectionName="payments"/>
    </changeSet>

    <changeSet id="2" author="mikitatsikhan">
        <ext:runCommand>
            <ext:command>
                {
                    "collMod": "payments",
                    "validator": {
                    "$jsonSchema": {
                        "bsonType": "object",
                        "required": ["order_id", "user_id", "status", "timestamp", "payment_amount"],
                        "properties": {
                            "_id": {
                                "bsonType": "objectId",
                                "description": "Payment ID must be an ObjectId"
                            },
                            "order_id": {
                                "bsonType": "long",
                                "description": "Order ID must be a long"
                            },
                            "user_id": {
                                "bsonType": "long",
                                "description": "User ID must be a long"
                            },
                            "status": {
                                "enum": ["SUCCESS", "FAILED"],
                                "description": "Status must be one of the enum values"
                            },
                            "timestamp": {
                                "bsonType": "date",
                                "description": "Timestamp must be a date"
                            },
                            "payment_amount": {
                                "bsonType": "decimal",
                                "description": "Payment amount must be a decimal"
                            }
                        }
                    }
                },
                "validationLevel": "moderate"
                }
            </ext:command>
        </ext:runCommand>
    </changeSet>

    <changeSet id="3" author="mikitatsikhan">
        <ext:createIndex collectionName="payments">
            <ext:keys>
                { "user_id": 1 }
            </ext:keys>
            <ext:options>
                { "name": "idx_user_id" }
            </ext:options>
        </ext:createIndex>
    </changeSet>

    <changeSet id="4" author="mikitatsikhan">
        <ext:createIndex collectionName="payments">
            <ext:keys>
                { "order_id": 1 }
            </ext:keys>
            <ext:options>
                { "name": "idx_order_id", unique: true }
            </ext:options>
        </ext:createIndex>
    </changeSet>
</databaseChangeLog>